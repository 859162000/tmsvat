(function(){dorado.widget.ImportExcelAction=$extend(dorado.widget.Action,{$className:"dorado.widget.ImportExcelAction",ATTRIBUTES:{async:{defaultValue:true},timeout:{},batchable:{defaultValue:true},excelModelId:{},startRow:{defaultValue:0},endRow:{defaultVaule:0},showImportData:{defaultValue:true},width:{defaultVaule:"98%"},height:{defaultVaule:"98%"},parameter:{},},doExecute:function(a){this.doExecuteAsync(a)},execute:function(a){this.doExecuteAsync(a)},doExecuteAsync:function(j){var h=this._view,b=this,i=this._showImportData;if(!b._excelModelId){throw new dorado.Exception("excelModelId is null")}b.set("disabled",false);function k(){e.close();jQuery(g.getDom()).remove();jQuery(f.getDom()).remove();var o=new dorado.widget.Button({caption:"解析入库",icon:"url(>skin>common/icons.gif) -120px -280px",listener:{onClick:function(q,p){a.execute(function(r){q.set("disabled",true);n.close();$callback(j,true,r)})}}});var n=new dorado.widget.Dialog({width:"98%",height:"98%",center:true,closeAction:"hide",status:"hidden",maximizeable:true,modal:true,caption:"导入Excel数据预览",view:h,animateType:"none",buttons:[o],listener:{onClose:function(q,p){h.removeChild(a);h.removeChild(c)}}});var m="dataimport.view.online.DataViewMaintain.ling?excelModelId="+b._excelModelId;var l=new dorado.widget.IFrame({path:m,height:"100%",width:"100%",path:m});n.addChild(l);n.show()}function d(){dorado.MessageBox.confirm("文件上传成功，是否需要导入数据?",function(){a.execute(function(l){e.close();$callback(j,true,l)})})}var a=h.id("$parseAction");if(a==null){a=new dorado.widget.AjaxAction({view:h,id:"$parseAction",service:"bdf.ExcelMaintain#processParserdExcelData",parameter:{excelModelId:b._excelModelId},executingMessage:"正在导入数据..."})}var c=h.id("$uploadActionExcel");if(c==null){c=new dorado.widget.UploadAction({id:"$uploadActionExcel",fileResolver:"excelImportUploadResolver#process",autoUpload:true,listener:{onFilesAdded:function(n,m){var p="",o;if(m.files.length>1){p="请选择一个Excel格式的文件"}else{o=m.files[0].name;if(!(new RegExp(".xls$").test(o)||new RegExp(".xlsx$").test(o))){p="请选择一个Excel格式的文件"}}if(p.length>0){e.close();throw new dorado.Exception(p)}var q={startRow:b._startRow||0,endRow:b._endRow||0,excelModelId:b._excelModelId};for(var l in b._parameter){q[l]=b._parameter[l]}n.set("parameter",q);n.taskId=dorado.util.TaskIndicator.showTaskIndicator("正在上传文件"+o+"...","main")},onFileUploaded:function(m,l){if(m.taskId){dorado.util.TaskIndicator.hideTaskIndicator(m.taskId)}if(l.returnValue&&l.returnValue.length>0){e.close();throw new dorado.Exception(l.returnValue)}if(i!=false){k()}else{d()}},onError:function(m,l){if(m.taskId){dorado.util.TaskIndicator.hideTaskIndicator(m.taskId)}return false}}})}var g=new dorado.widget.Button({caption:"上传Excel文件",icon:"url(>skin>common/icons.gif) -120px -280px",action:"$uploadActionExcel"});var f=new dorado.widget.Button({caption:"下载模板",icon:"url(>skin>common/icons.gif) -140px -240px",listener:{onClick:function(m,l){window.location.href="attachment.download.action?groupId=exceltemplate&relationId="+b._excelModelId}}});var e=new dorado.widget.Dialog({width:350,height:150,center:true,closeAction:"hide",status:"hidden",maximizeable:false,modal:true,caption:"导入Excel文件",view:h,animateType:"none",buttons:[g,f],listener:{onClose:function(m,l){h.removeChild(c);h.removeChild(f);h.removeChild(a)},onHide:function(m,l){h.removeChild(c);h.removeChild(f);h.removeChild(a)}}});h.addChild(e);e.show()}})})();