<#assign pojo=oneToManyPojo.getOne()>
<#assign many=oneToManyPojo.getMany()>
<#assign ones=oneToManyPojo.getOnes()>
<#assign service="${pojo.getDeclarationNameFirstLetterLower()}Service">
<#assign declarationName = pojo.importType(pojo.getDeclarationName())>
<#assign declarationName_firstLower = pojo.getDeclarationNameFirstLetterLower()>
package ${pojo.getPackageName()}.view;
// Generated by bo.wang with ${version}

import java.io.Serializable;
import java.util.Collection;
import java.util.Map;
import java.util.List;
import java.util.ArrayList;

import javax.annotation.Resource;

import org.springframework.stereotype.Component;

import com.bstek.dorado.annotation.DataProvider;
import com.bstek.dorado.annotation.DataResolver;
import com.bstek.dorado.annotation.Expose;
import com.bstek.dorado.data.provider.Page;
import com.ling2.core.commons.constant.TableColnumDef;
import com.ling2.core.commons.support.DaoPage;
import com.ling2.core.commons.utils.D7PageUtils;
import com.ling2.core.commons.utils.ViewUtils;
import com.ling2.core.commons.utils.AssertHelper;
import com.ling2.core.commons.utils.reflect.ReflectUtils;
import ${pojo.getPackageName()}.model.${declarationName};
import ${pojo.getPackageName()}.model.${declarationName}Param;
<#foreach child in many>
<#assign childdeclarationName = child.importType(child.getDeclarationName())>	
import ${child.getPackageName()}.model.${childdeclarationName}Param;
</#foreach>
<#foreach child in ones>
<#assign childdeclarationName = child.importType(child.getDeclarationName())>	
import ${child.getPackageName()}.model.${childdeclarationName}Param;
</#foreach>
import ${pojo.getPackageName()}.service.${declarationName}Service;
/**
 * Home object for domain model class ${declarationName}.
 * @see ${pojo.getQualifiedDeclarationName()}
 * @author Hibernate Tools
 */
@Component("${pojo.getDeclarationNameFirstLetterLower()}View")
public class ${declarationName}View {
	@Resource
	${declarationName}Service ${service};
	@DataProvider
	public List<${declarationName}Param> load${declarationName}s(Map params){
		String flag=ViewUtils.getParamValue(TableColnumDef.FLAG_DEF, params,true)?TableColnumDef.FLAG_EFFECT:null;
		List<${declarationName}Param> results;
		//是否获取失效数据
		if(AssertHelper.notEmpty(flag)&&TableColnumDef.FLAG_EFFECT.equals(flag) ){
			results= ${service}.getEffect${declarationName}CacheTree();
		}else {
			results= ${service}.get${declarationName}CacheTree();
		}
		//是否只显示匹配项
		Boolean matchonly=ViewUtils.getParamValue("matchonly", params);
		//搜索的关键字
		//搜索的关键字
		String name=ViewUtils.getParamValue("name", params);
		String code=ViewUtils.getParamValue("code", params);
		/**
		 * 只有name,code不为空的时候才执行此逻辑,否则都是显示树
		 */
		if(AssertHelper.notEmpty(matchonly)&&matchonly&&(AssertHelper.notEmpty(name)||AssertHelper.notEmpty(code))){			
			if(AssertHelper.notEmpty(name)){
				List<${declarationName}Param> matchs=new ArrayList<${declarationName}Param>();
				searchMatchOnly(results, matchs, params);
				return matchs;
			}
		}else{
			searchMatch(results, params);
		}
		return results;
	}
	@DataResolver
	public void save${declarationName}Node(${declarationName}Param ${declarationName_firstLower}){
		${service}.save${declarationName}Node(${declarationName_firstLower});
		${service}.flush${declarationName}CacheTree();
	}
	@DataProvider
	public List<${declarationName}Param> loadEffect${declarationName}s(Map params){
		return ${service}.getEffect${declarationName}CacheTree();
	}
	@Expose
	public void flush${declarationName}Cache(){
		${service}.flush${declarationName}CacheTree();
	}
	private void searchMatchOnly(List<${declarationName}Param> depts, List<${declarationName}Param> matchs, Map params) {
		for(${declarationName}Param dept:depts){
			String currentId=ViewUtils.getParamValue("currentId", params);
			if(AssertHelper.notEmpty(currentId)&&currentId.equals(dept.getCode())){//如果有currentId并且相等,不再递归查找下节点
				
			}else{
				searchMatchOnly(dept.getRel${declarationName}s(), matchs, params);
				String code=ViewUtils.getParamValue("code", params);
				String name=ViewUtils.getParamValue("name", params);
				if((AssertHelper.notEmpty(name)&&dept.getName().indexOf(name)>=0)||(AssertHelper.notEmpty(code)&&dept.getCode().indexOf(code)>=0)){		
					${declarationName}Param inParam=new ${declarationName}Param();
					ReflectUtils.copyProperties(dept, inParam);
					inParam.setHot(true);
					dept.setChecked(true);
					matchs.add(inParam);
				}
			}			
		}
	}
	private void searchMatch(List<${declarationName}Param> depts, Map params) {
		String name=ViewUtils.getParamValue("name", params);
		List<${declarationName}Param> results=new ArrayList<${declarationName}Param>();
		for(${declarationName}Param dept:depts){		
			String currentId=ViewUtils.getParamValue("currentId", params);
			if(AssertHelper.notEmpty(currentId)&&currentId.equals(dept.getCode())){//如果有currentId并且相等,不再递归查找下节点

			}else {
				${declarationName}Param temp=new ${declarationName}Param();
				ReflectUtils.copyProperties(dept, temp);
				temp.setRel${declarationName}s(dept.getRel${declarationName}s());
				if(temp.getRel${declarationName}s()!=null){
					searchMatch(temp.getRel${declarationName}s(),params);
				}				
				if(AssertHelper.notEmpty(name)&&temp.getName().indexOf(name)>=0){		
					temp.setHot(true);
					temp.setChecked(true);
				}
				results.add(temp);
			}						
		}
		depts.clear();
		depts.addAll(results);
	}
	@DataProvider
	public void load${declarationName}(Page<${declarationName}Param> page, Map<String, Object> map) throws Exception {
		DaoPage daoPage=${service}.find${declarationName}ByParams(map, page.getPageNo(), page.getPageSize());
		D7PageUtils.daoPageToPage(daoPage, page);
	}
	@DataProvider
	public Collection<${declarationName}Param> load${declarationName}(Map<String, Object> map) throws Exception {
		List result=${service}.find${declarationName}ByParams(map);
		return result;
	}
	@DataProvider
	public ${declarationName}Param loadAdd${declarationName}(Map<String, Object> map) throws Exception {
		${declarationName}Param param=new ${declarationName}Param();
		return param;
	}
	@DataProvider
	public ${declarationName}Param loadModify${declarationName}(Map<String, Object> map) throws Exception {
		Object id=map.get("id");
		AssertHelper.notEmpty_assert(id,"编辑的主键不能为空");
		${declarationName} entity=(${declarationName})${service}.get(${declarationName}.class,Long.parseLong(id.toString()));
		${declarationName}Param param=${service}.convert${declarationName}ToParam(entity);
		return param;
	}
	@DataResolver
	public void save${declarationName}(Collection<${declarationName}Param> objs) throws Exception {
		Map results= D7PageUtils.assembleDatasetMap(objs);
		${service}.save${declarationName}DataListsMap(results);
	}
	@DataResolver
	public void saveAdd${declarationName}(${declarationName}Param param) throws Exception {
		${declarationName} entity=${service}.convert${declarationName}ParamToEntity(param);
		if(entity.getId()==null){
			${service}.save(entity);
		}
		else{
			${service}.update(entity);
		}
		param.setId(entity.getId());
	}
	@DataResolver
	public void updateModify${declarationName}(${declarationName}Param param) throws Exception {
		${declarationName} entity=(${declarationName})${service}.get(${declarationName}.class,param.getId());
		ReflectUtils.copyProperties(param, entity);
		${service}.update(entity);
	}
<#foreach child in many>
<#assign childdeclarationName = child.importType(child.getDeclarationName())>	
<#assign tempchild=child>	
	@DataProvider
	public void load${childdeclarationName}(Page<${childdeclarationName}Param> page, Map<String, Object> map) throws Exception {
		DaoPage daoPage=${service}.find${childdeclarationName}ByParams(map, page.getPageNo(), page.getPageSize());
		D7PageUtils.daoPageToPage(daoPage, page);
	}
	@DataProvider
	public Collection load${childdeclarationName}(Map<String, Object> map) throws Exception {
		List result=${service}.find${childdeclarationName}ByParams(map);
		return result;
	}
	@DataResolver
	public void save${childdeclarationName}(Collection<${childdeclarationName}Param> objs) throws Exception {
		Map results= D7PageUtils.assembleDatasetMap(objs);
		${service}.save${childdeclarationName}DataListsMap(results);
	}
</#foreach>
<#foreach child in ones>
<#assign childdeclarationName = child.importType(child.getDeclarationName())>	
	@DataProvider
	public ${childdeclarationName} find${childdeclarationName}(Map params)
	{
		return ${service}.find${childdeclarationName}(params);
	}
	@DataProvider
	public ${childdeclarationName} loadAdd${childdeclarationName}(Map params)
	{
		${childdeclarationName} result=new ${childdeclarationName}();
		return result;
	}
	@DataResolver
	public void save${childdeclarationName}(${childdeclarationName}Param obj) throws Exception {
		if(obj.getId()==null)
		{
			obj.setId(-1l);
			${service}.save(obj);
		}else {
			${service}.update(obj);
		}
	}
</#foreach>
}